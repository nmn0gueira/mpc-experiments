# EMP-toolkit
[EMP-toolkit](https://github.com/emp-toolkit) is a set of MPC frameworks based on garbled circuits written in C++ and used as libraries. This repository tests the [semi-honest implementation of Yao](https://github.com/emp-toolkit/emp-sh2pc) (`sh2pc`).

## Development
Development was done through a development container using the repository's `devcontainer.json` file along with its Dockerfile. This will allow you to develop in a consistent environment with all the necessary dependencies.

To use the development container, you will need Docker installed on your machine and a code editor that supports devcontainers (e.g., Visual Studio Code).

Alternatively, you can set up the environment manually on Ubuntu 24.04 with the following dependencies:
- software-properties-common
- cmake
- build-essential
- libssl-dev


## Compilation

```bash
mkdir build
cd build
cmake ..
make
```

## Usage
### Generating input data
To run the examples, you will need sample data. This data can be generated with the python script included in the repository. Usage of the script is as follows:

```bash
python3 scripts/geninput.py -e <ex> -l <numrows> -x <num> -y <num>
```

The default for -l (input length) is 10, while the defaults for -x and -y differ between programs (both have a default of 4 for xtabs or 5 for hist2d and correspond to number of categories and number of bins of alice and bob, respectively).

### Running the examples
Some examples may have slightly different arguments where it is best to check the usage by simplifying executing the program without arguments. In general, to run an example you can run the following command for Alice:

```bash
./bin/<ex> 1 <port> <input file>
```

And the following for Bob:

```bash
./bin/<ex> 2 <port> <ip> <input file>
```

Alternatively, you can use the `run.sh` script for easier usage:
```bash
scripts/run.sh [-a] [-b <alice_address>] <program_name> [<args>]
```
The `-a` and `-b` flags are used to indicate which party is running the program. If Bob is running the program, Alice's address should be provided within the `-b` flag.
This script will automatically use the input generated by the `geninput.py` script and run the programs with fixed parameters. If running both parties in the same terminal, Alice will be the one printing the program output while Bob will only print the amount of data sent to maintain the terminal output clean.

#### Docker
To run the examples in a Docker environment, you can either build a custom Docker image using the included `Dockerfile`, or use the provided `compose.yaml` file. When using Docker Compose, make sure to set the required arguments in a Linux environment using export commands.

## Additional Notes
- `xtabs`:
    - The `average` function has two implementations: 
        - One that uses integers and either reveals the sum and count of the values before calculating the averages themselves or calculates the averages with integer division (default) to avoid working with floats inside the circuit, making it faster and more efficient at the expense of leaking more information about the data or losing some precision, respectively.
        - One that uses floats and performs the whole computation within the circuit, maintaining precision and avoiding leaking information about the data, but at the cost of performance.
- `hist2d`:
    - The `hist2d` function uses integers for the binning of the data. This may very slightly impact precision loss in binning but proves much more efficient. An implementation that works with floats is included as well.


## TODO
This section includes work that has not been completed yet for this particular framework.

### Optimizations
- `xtabs`: 
    - The standard deviation aggregation can be optimized by revealing certain components of the computation or inputting revealed values such as the averages previously computed. Just having the average revealed is already a good optimization as it reduces the amount of floating point operations in the circuit (which is the main bottleneck of the function).

### Additions
- `ag2pc`:
	- Add testing for the maliciously secure protocol with authenticated garbling. This would require some adaptations to current programs to be able to generate the garbled circuit for a given program. 
    > Additionally, the `ag2pc` protocol seems to require all inputs of a party to be initialized before the inputs of the other party. For `xtabs` for example, this means specifying the columns of one party before the other (e.g., `a0a1 b1`, `b0b1 a0`, etc.).